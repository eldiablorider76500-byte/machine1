<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Machine Ã  sous TikTok â€“ 3B</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:Arial, sans-serif;
      background:#0c0f1a;
      color:#fff;
      display:flex;
      gap:20px;
      padding:20px;
      height:100vh;
    }

    /* ============================
       COLONNE DROITE (Sidebar)
    =============================*/
    .sidebar{
      width:320px;
      background:#111727;
      padding:15px;
      border-radius:12px;
      display:flex;
      flex-direction:column;
      gap:22px;
      box-shadow:0 0 20px #000;
    }

    .sidebar h3{
      font-size:16px;
      margin-bottom:6px;
      color:#ffd54f;
      text-transform:uppercase;
    }

    .side-box{
      background:#1a2135;
      padding:10px;
      border-radius:8px;
      font-size:13px;
      max-height:200px;
      overflow-y:auto;
    }

    /* ============================
       MACHINE Ã€ SOUS
    =============================*/
    .machine{
      flex:1;
      background:#141b2e;
      border-radius:20px;
      padding:20px;
      box-shadow:0 0 25px #000;
      display:flex;
      flex-direction:column;
    }

    .machine-title{
      text-align:center;
      font-size:32px;
      font-weight:bold;
      color:#ffd54f;
      margin-bottom:4px;
    }

    .machine-subtitle{
      text-align:center;
      font-size:13px;
      opacity:0.8;
      margin-bottom:15px;
    }

    .status{
      display:flex;
      justify-content:space-between;
      padding:8px;
      background:#1d243a;
      border-radius:10px;
      margin-bottom:15px;
      font-size:13px;
    }

    .reels{
      background:#0f1524;
      padding:20px;
      border-radius:15px;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:15px;
      margin-bottom:20px;
    }

    .reel{
      background:#131b2f;
      width:120px;
      height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      box-shadow:inset 0 0 10px #000;
      overflow:hidden;
    }

    .reel img{
      width:90%;
    }

    .controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .btn{
      padding:10px 20px;
      border-radius:30px;
      border:none;
      cursor:pointer;
      font-size:14px;
      font-weight:bold;
      text-transform:uppercase;
      box-shadow:0 0 10px #000;
    }

    .btn-gift{background:#ffca28;color:#000;}
    .btn-spin{background:#4caf50;color:#fff;}

    .win-banner{
      position:absolute;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      background:#000a;
      padding:10px 20px;
      border-radius:30px;
      font-size:16px;
      display:none;
      text-align:center;
    }
  </style>
</head>
<body>

<!-- =============================
     COLONNE DROITE
============================== -->
<div class="sidebar">

  <div>
    <h3>Connexion TikTok</h3>
    <div class="side-box" id="tiktokStatus">DÃ©connectÃ©</div>
  </div>

  <div>
    <h3>File d'attente</h3>
    <div class="side-box" id="queueBox">Aucun joueur en attente.</div>
  </div>

  <div>
    <h3>Historique gagnants</h3>
    <div style="font-size:12px;margin-bottom:5px;">
      Total gagnants : <span id="historyCount">0</span>
    </div>
    <div class="side-box" id="historyBox">Aucun gagnant.</div>
  </div>

</div>

<!-- =============================
     MACHINE Ã€ SOUS
============================== -->
<div class="machine">

  <div class="machine-title">Slot 3B TikTok</div>
  <div class="machine-subtitle">4 symboles identiques = GAIN !</div>

  <div class="status">
    <div>Joueur : <span id="playerName">-</span></div>
    <div>Tours restants : <span id="spinsLeft">0</span></div>
    <div>Total spins : <span id="totalSpins">0</span></div>
  </div>

  <div class="reels">
    <div class="reel"><img id="r1" src=""></div>
    <div class="reel"><img id="r2" src=""></div>
    <div class="reel"><img id="r3" src=""></div>
    <div class="reel"><img id="r4" src=""></div>
  </div>

  <div class="controls">
    <button class="btn btn-spin" id="spinBtn" disabled>SPIN</button>
  </div>

</div>

<!-- =============================
       SCRIPT MACHINE
============================== -->
<script>
// =============================
// IMAGES CDN (PAS DE DOSSIER)
// =============================
const IMAGES = {
  cygne: "https://i.imgur.com/ahxB4so.png",
  loup: "https://i.imgur.com/fm6t5eP.png",
  moto: "https://i.imgur.com/iIurx1y.png",
  donuts: "https://i.imgur.com/Ly7T8HX.png",
  confetti: "https://i.imgur.com/YgEzp2P.png",
  parfum: "https://i.imgur.com/sHvFvwj.png",
  rosa: "https://i.imgur.com/yMT3h7T.png"
};

// =============================
// VARIABLES
// =============================
let queue = [];
let current = null;
let totalSpins = 0;
let history = [];

const tiktokStatus = document.getElementById("tiktokStatus");
const queueBox      = document.getElementById("queueBox");
const historyBox    = document.getElementById("historyBox");
const historyCount  = document.getElementById("historyCount");

const playerName = document.getElementById("playerName");
const spinsLeft  = document.getElementById("spinsLeft");
const totalSpinsEl = document.getElementById("totalSpins");

const spinBtn = document.getElementById("spinBtn");

// =============================
// CONNEXION AU SERVEUR NODE
// =============================
let ws = new WebSocket("ws://localhost:8080");

ws.onopen = () => tiktokStatus.innerHTML = "ðŸŸ¢ ConnectÃ©";
ws.onclose = () => tiktokStatus.innerHTML = "ðŸ”´ DÃ©connectÃ©";

ws.onmessage = (msg)=>{
  let data = JSON.parse(msg.data);

  if(data.type === "gift"){
    addToQueue(data.username, data.coins);
  }
};

// =============================
// FILE D'ATTENTE
// =============================

function calcSpins(coins){
  if(coins >= 2999) return 70;
  if(coins >= 299) return 7;
  if(coins >= 99) return 3;
  if(coins >= 49) return 1;
  return 0;
}

function addToQueue(username, coins){
  let tours = calcSpins(coins);
  if(tours === 0) return;

  queue.push({username, tours});
  refreshQueue();

  if(!current) startNextPlayer();
}

function refreshQueue(){
  if(queue.length === 0){
    queueBox.innerHTML = "Aucun joueur en attente.";
    return;
  }

  queueBox.innerHTML = queue.map((u,i)=>
    `${i+1}. @${u.username} â€” ${u.tours} tour(s)`
  ).join("<br>");
}

function startNextPlayer(){
  if(queue.length === 0){
    current = null;
    spinBtn.disabled = true;
    playerName.innerHTML = "-";
    spinsLeft.innerHTML = "0";
    return;
  }

  current = queue[0];
  playerName.innerHTML = current.username;
  spinsLeft.innerHTML  = current.tours;
  spinBtn.disabled = false;
}

// =============================
// SPIN
// =============================
spinBtn.onclick = ()=>{
  if(!current) return;

  current.tours--;
  spinsLeft.innerHTML = current.tours;

  spin();
};

// =============================
// ANIMATION SPIN
// =============================
function randomSymbol(){
  const keys = Object.keys(IMAGES);
  return keys[Math.floor(Math.random()*keys.length)];
}

function spin(){
  totalSpins++;
  totalSpinsEl.innerHTML = totalSpins;

  let s1 = randomSymbol();
  let s2 = randomSymbol();
  let s3 = randomSymbol();
  let s4 = randomSymbol();

  document.getElementById("r1").src = IMAGES[s1];
  document.getElementById("r2").src = IMAGES[s2];
  document.getElementById("r3").src = IMAGES[s3];
  document.getElementById("r4").src = IMAGES[s4];

  // WIN ?
  if(s1 === s2 && s2 === s3 && s3 === s4){
    addWinner(current.username, s1);
  }

  if(current.tours <= 0){
    queue.shift();
    refreshQueue();
    startNextPlayer();
  }
}

// =============================
// HISTORIQUE GAGNANTS
// =============================
function addWinner(username, symbol){
  history.push({username, symbol});
  historyCount.innerHTML = history.length;

  historyBox.innerHTML = history.map((h,i)=>
    `${i+1}. @${h.username} â€” 4Ã— ${h.symbol}`
  ).join("<br>");
}
</script>

</body>
</html>
