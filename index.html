<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Machine Ã  sous TikTok â€“ 3B</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d3350 0, #050811 55%, #02030a 100%);
      color:#fff;
      height:100vh;
      display:flex;
      padding:20px;
      gap:20px;
    }

    /* --- Colonne gauche = Machine --- */
    .machine-wrapper {
      flex: 1;
      min-width: 700px;
      border-radius:40px;
      padding:20px 24px 28px;
      background:linear-gradient(180deg,#2c0f33 0%,#120615 50%,#20183b 100%);
      box-shadow:0 0 40px rgba(0,0,0,0.8),0 0 80px rgba(147,51,234,0.6);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .machine-header {
      text-align:center;
      margin-bottom:10px;
    }

    .machine-title {
      font-size:32px;
      letter-spacing:3px;
      text-transform:uppercase;
      font-weight:800;
      color:#ffd54f;
      text-shadow:0 0 12px rgba(255,215,0,0.9),0 0 24px rgba(255,64,129,0.7);
    }

    .machine-subtitle {
      margin-top:4px;
      font-size:13px;
      color:#e1e1ff;
      opacity:0.85;
    }

    .top-status {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 0 12px;
      font-size:13px;
      color:#e5e5ff;
    }

    .player-info span {
      font-weight:600;
      color:#ffeb3b;
    }

    .spin-counter {
      font-size:12px;
      color:#b0a5ff;
    }

    .machine-body {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .reels-container {
      flex:1;
      border-radius:26px;
      padding:18px 14px;
      background:radial-gradient(circle at top,#3147a0,#0b1023 55%,#040612 100%);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }

    .reels-frame {
      width:100%;
      max-width:820px;
      height:100%;
      max-height:320px;
      border-radius:22px;
      padding:16px;
      background:linear-gradient(180deg,#ff00b8,#ff9100);
      box-shadow:0 0 28px rgba(255,64,129,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .reels-inner {
      flex:1;
      height:100%;
      background:radial-gradient(circle at top,#121b33,#050814 70%);
      border-radius:18px;
      border:4px solid rgba(255,255,255,0.05);
      display:flex;
      justify-content:space-evenly;
      align-items:center;
      padding:10px 14px;
      gap:10px;
    }

    .reel {
      flex:1;
      max-width:150px;
      height:100%;
      border-radius:16px;
      background:linear-gradient(180deg,#171f33,#050713);
      box-shadow:inset 0 0 15px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }

    .reel img {
      width:80%;
      max-height:90%;
      object-fit:contain;
      filter:drop-shadow(0 0 12px rgba(0,0,0,0.9));
      transition:transform 0.08s linear;
    }

    .reel.spinning img {
      animation:wiggle 0.1s linear infinite;
      opacity:0.9;
    }

    @keyframes wiggle {
      0%{transform:translateY(-4px);}
      50%{transform:translateY(4px);}
      100%{transform:translateY(-4px);}
    }

    .win-banner {
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      padding:6px 16px;
      border-radius:999px;
      background:rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.2);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:1px;
      color:#fff;
      display:none;
      align-items:center;
      gap:8px;
      pointer-events:none;
      z-index:5;
    }

    .machine-footer {
      display:flex;
      gap:14px;
      align-items:center;
      margin-top:6px;
    }

    .control-panel {
      flex:2;
      background:rgba(0,0,0,0.4);
      border-radius:18px;
      padding:10px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      align-items:center;
      font-size:13px;
    }

    .control-panel label {
      font-size:12px;
      color:#ddd;
    }

    .control-panel input {
      background:rgba(7,10,26,0.9);
      border:1px solid rgba(255,255,255,0.15);
      color:#fff;
      border-radius:999px;
      padding:5px 10px;
      font-size:13px;
      outline:none;
      min-width:110px;
    }

    .helper-text {
      font-size:11px;
      color:#b9b9ff;
      margin-top:4px;
      opacity:0.8;
    }

    .btn {
      border-radius:999px;
      border:none;
      padding:9px 18px;
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      cursor:pointer;
      transition:0.08s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .btn-primary {
      background:radial-gradient(circle at top,#00e676,#00b0ff);
      color:#011017;
    }

    .btn-secondary {
      background:radial-gradient(circle at top,#ffea00,#ff6f00);
      color:#120300;
    }

    /* ---- Colonne droite ---- */
    .sidebar {
      width:350px;
      background:rgba(0,0,0,0.35);
      border-radius:20px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:20px;
      box-shadow:0 0 30px rgba(0,0,0,0.6);
    }

    .sidebar h3 {
      margin-bottom:6px;
      font-size:16px;
      text-transform:uppercase;
      color:#ffd54f;
    }

    .side-box {
      background:rgba(255,255,255,0.05);
      padding:10px;
      border-radius:10px;
      font-size:13px;
      max-height:200px;
      overflow-y:auto;
    }
  </style>
</head>
<body>
  <!-- Colonne droite -->
  <div class="sidebar">
    <div>
      <h3>Connexion TikTok</h3>
      <div id="tiktokStatus" class="side-box">DÃ©connectÃ©</div>
    </div>

    <div>
      <h3>File d'attente</h3>
      <div id="queueList" class="side-box">Aucun joueur en attente.</div>
    </div>

    <div>
      <h3>Historique des gagnants</h3>
      <div style="font-size:12px;margin-bottom:4px;">
        Total gagnants : <span id="historyCount">0</span>
      </div>
      <div id="historyList" class="side-box">Aucun gagnant pour lâ€™instant.</div>
    </div>
  </div>

  <!-- Machine Ã  sous -->
  <div class="machine-wrapper">
    <div class="machine-header">
      <div class="machine-title">Slot 3B TikTok</div>
      <div class="machine-subtitle">
        4 mÃªmes cadeaux = GAIN â€¢ Loup = <strong>GIGA WIN</strong> â€¢ Moto = <strong>MEGA WIN</strong>
      </div>
    </div>

    <div class="top-status">
      <div class="player-info">
        Joueur : <span id="playerNameDisplay">-</span> â€¢ Cadeau : <span id="giftCoinsDisplay">0</span> piÃ¨ces â€¢ Tours restants : <span id="spinsLeftDisplay">0</span>
      </div>
      <div class="spin-counter">
        Tours jouÃ©s : <span id="totalSpinsDisplay">0</span>
      </div>
    </div>

    <div class="machine-body">
      <div class="reels-container">
        <div id="winBanner" class="win-banner">
          <span id="winTypeLabel"></span> â€” <span id="winSymbolLabel"></span>
        </div>

        <div class="reels-frame">
          <div class="reels-inner">
            <div class="reel" data-index="0"><img src="" alt="reel 1"></div>
            <div class="reel" data-index="1"><img src="" alt="reel 2"></div>
            <div class="reel" data-index="2"><img src="" alt="reel 3"></div>
            <div class="reel" data-index="3"><img src="" alt="reel 4"></div>
          </div>
        </div>
      </div>

      <div class="machine-footer">
        <div class="control-panel">
          <div>
            <label for="playerName">Pseudo TikTok :</label><br>
            <input id="playerName" type="text" placeholder="Pseudoâ€¦" />
          </div>
          <div>
            <label for="giftCoins">Valeur du cadeau (piÃ¨ces) :</label><br>
            <input id="giftCoins" type="number" min="1" placeholder="ex: 99" />
          </div>

          <div class="helper-text">
            Minimum <strong>49 piÃ¨ces</strong><br>
            49â€“98 = 1 tour â€¢ 99â€“298 = 3 tours â€¢ 299â€“2998 = 7 tours â€¢ 2999+ = 70 tours
          </div>
        </div>

        <div class="buttons-panel">
          <button id="setGiftBtn" class="btn btn-secondary">Valider le cadeau</button>
          <button id="spinBtn" class="btn btn-primary" disabled>SPIN</button>
        </div>
      </div>
    </div>
  </div>
<script>
// ========================
// Variables globales
// ========================

let queue = [];               // File d'attente
let history = [];             // Liste des gagnants
let isSpinning = false;       // Ã‰vite double-spin
let currentPlayer = null;     // Joueur actif
let totalSpins = 0;           // Pour ton cycle
let nextSmallRewardAt = 15;   // Cycle des petits wins
let moto200Given = false;     // Cycle moto
let big260Index = 0;          // Index du cycle 260

// ========================
// SÃ©lecteurs HTML
// ========================

const queueListEl    = document.getElementById("queueList");
const historyListEl  = document.getElementById("historyList");
const historyCountEl = document.getElementById("historyCount");
const tiktokStatusEl = document.getElementById("tiktokStatus");

const playerNameDisplay = document.getElementById("playerNameDisplay");
const giftCoinsDisplay  = document.getElementById("giftCoinsDisplay");
const spinsLeftDisplay  = document.getElementById("spinsLeftDisplay");
const totalSpinsDisplay = document.getElementById("totalSpinsDisplay");

const setGiftBtn = document.getElementById("setGiftBtn");
const spinBtn    = document.getElementById("spinBtn");

const reels = Array.from(document.querySelectorAll(".reel"));
const winBanner = document.getElementById("winBanner");
const winTypeLabel = document.getElementById("winTypeLabel");
const winSymbolLabel = document.getElementById("winSymbolLabel");

// ========================
// Connexion WebSocket au serveur Node
// ========================

let ws = new WebSocket("ws://localhost:8080");

ws.onopen = () => {
  tiktokStatusEl.innerHTML = "ðŸŸ¢ ConnectÃ© au serveur";
};
ws.onclose = () => {
  tiktokStatusEl.innerHTML = "ðŸ”´ DÃ©connectÃ©";
};
ws.onerror = () => {
  tiktokStatusEl.innerHTML = "âš ï¸ Erreur WebSocket";
};

// Quand un cadeau arrive du serveur (TikTok ou Test)
ws.onmessage = (msg) => {
  let data = JSON.parse(msg.data);

  if (data.type === "gift") {
    addToQueue(data.username, data.coins);
  }
};

// ========================
// File d'attente
// ========================

function addToQueue(pseudo, coins) {
  let tours = calcSpinsFromCoins(coins);
  if (tours <= 0) return;

  queue.push({ pseudo, tours });
  renderQueue();
  if (!currentPlayer) startNextPlayer();
}

function renderQueue() {
  if (queue.length === 0) {
    queueListEl.innerHTML = "Aucun joueur en attente.";
    return;
  }

  let html = "";
  queue.forEach((p, i) => {
    html += `${i + 1}. ${p.pseudo} â€” ${p.tours} tour(s)<br>`;
  });
  queueListEl.innerHTML = html;
}

// ========================
// Gestion des gagnants
// ========================

function addWinner(pseudo, symbolLabel) {
  history.push({
    pseudo: pseudo,
    symbol: symbolLabel
  });

  renderHistory();
}

function renderHistory() {
  historyCountEl.textContent = history.length;

  if (history.length === 0) {
    historyListEl.innerHTML = "Aucun gagnant pour lâ€™instant.";
    return;
  }

  let html = "";
  history.forEach((h, i) => {
    html += `${i + 1}. ${h.pseudo} â€” 4Ã— ${h.symbol}<br>`;
  });

  historyListEl.innerHTML = html;
}

// ========================
// Gestion joueur actif
// ========================

function startNextPlayer() {
  if (queue.length === 0) {
    currentPlayer = null;
    spinBtn.disabled = true;
    playerNameDisplay.textContent = "-";
    giftCoinsDisplay.textContent = "0";
    spinsLeftDisplay.textContent = "0";
    return;
  }

  currentPlayer = queue[0];

  playerNameDisplay.textContent = currentPlayer.pseudo;
  giftCoinsDisplay.textContent  = "?";
  spinsLeftDisplay.textContent  = currentPlayer.tours;

  spinBtn.disabled = false;
}

// ========================
// Calcul nombre de tours selon les piÃ¨ces
// ========================

function calcSpinsFromCoins(c) {
  if (c >= 2999) return 70;
  if (c >= 299)  return 7;
  if (c >= 99)   return 3;
  if (c >= 49)   return 1;
  return 0;
}

// ========================
// Spin manuel
// ========================

spinBtn.onclick = () => {
  if (!currentPlayer || isSpinning) return;
  if (currentPlayer.tours <= 0) return;

  isSpinning = true;
  currentPlayer.tours--;
  spinsLeftDisplay.textContent = currentPlayer.tours;

  let finalSymbols = computeFinalSymbols();
  doSpinAnimation(finalSymbols);
};

// ========================
// Simulation des rÃ©sultats / cycles
// ========================

const SYMBOLS = [
  { id:"cygne", file:"IMG-20251120-WA0017.jpg", label:"Cygne royal", isBig:false },
  { id:"loup", file:"IMG-20251120-WA0018.jpg", label:"Loup", isBig:true, bigType:"giga" },
  { id:"rosejamais", file:"IMG-20251120-WA0019.jpg", label:"Rose Ã©ternelle", isBig:false },
  { id:"casquette", file:"IMG-20251120-WA0020.jpg", label:"Casquette", isBig:false },
  { id:"manette", file:"IMG-20251120-WA0021.jpg", label:"Manette", isBig:false },
  { id:"confetti", file:"IMG-20251120-WA0022.jpg", label:"Confetti", isBig:false },
  { id:"amourlangage", file:"IMG-20251120-WA0023.jpg", label:"Amour langage", isBig:false },
  { id:"donuts", file:"IMG-20251120-WA0024.jpg", label:"Donut", isBig:false },
  { id:"glace", file:"IMG-20251120-WA0025.jpg", label:"Glace", isBig:false },
  { id:"parfum", file:"IMG-20251120-WA0026.jpg", label:"Parfum", isBig:false },
  { id:"corgi", file:"IMG-20251120-WA0027.jpg", label:"Corgi", isBig:false },
  { id:"gants", file:"IMG-20251120-WA0028.jpg", label:"Gants boxe", isBig:false },
  { id:"rosa", file:"IMG-20251120-WA0029.jpg", label:"Rosa", isBig:false },
  { id:"gg", file:"IMG-20251120-WA0030.jpg", label:"GG", isBig:false },
  { id:"positivite", file:"IMG-20251120-WA0031.jpg", label:"PositivitÃ©", isBig:false },
  { id:"tofu", file:"IMG-20251120-WA0032.jpg", label:"Tofu", isBig:false },
  { id:"coeurdoigts", file:"IMG-20251120-WA0033.jpg", label:"CÅ“ur doigts", isBig:false },
  { id:"coeurnuage", file:"IMG-20251120-WA0034.jpg", label:"CÅ“ur nuage", isBig:false },
  { id:"moto", file:"IMG-20251120-WA0035.jpg", label:"Moto", isBig:true, bigType:"mega" },
  { id:"pistolet", file:"IMG-20251120-WA0042.jpg", label:"Pistolet argent", isBig:false }
];

const NON_BIG = SYMBOLS.filter(s => !s.isBig);

// Cycle spÃ©cial
const BIG_260_SEQUENCE = [
  "cygne","pistolet","moto","loup","pistolet","cygne","moto","pistolet","loup",
  "cygne","moto","cygne","pistolet","moto","loup"
];

function computeFinalSymbols() {

  totalSpins++;
  totalSpinsDisplay.textContent = totalSpins;

  let forced = null;

  // 1) Spin 200 â†’ moto obligatoire
  if (!moto200Given && totalSpins === 200) {
    forced = "moto";
    moto200Given = true;
  }

  // 2) Cycle 260
  else if (totalSpins > 200 && totalSpins % 260 === 0) {
    forced = BIG_260_SEQUENCE[big260Index];
    big260Index = (big260Index + 1) % BIG_260_SEQUENCE.length;
  }

  // 3) Petit win 15â€“20
  else if (totalSpins === nextSmallRewardAt) {
    let pool = ["donuts","rosa","manette","confetti","parfum","tofu","glace","casquette"];
    forced = pool[Math.floor(Math.random()*pool.length)];
    nextSmallRewardAt += Math.floor(Math.random()*6) + 15;
  }

  let result = [];

  if (forced) {
    let sym = SYMBOLS.find(x=>x.id===forced);
    return [sym,sym,sym,sym];
  }

  for (let i = 0; i < 4; i++) {
    result.push(NON_BIG[Math.floor(Math.random()*NON_BIG.length)]);
  }

  return result;
}

// ========================
// Animation du spin
// ========================

function doSpinAnimation(finalSymbols) {
  let stops = 0;
  let durations = [1500, 1800, 2100, 2400];

  reels.forEach((reel, i) => {

    reel.classList.add("spinning");

    let img = reel.querySelector("img");
    let shuffle = setInterval(() => {
      let r = NON_BIG[Math.floor(Math.random()*NON_BIG.length)];
      img.src = r.file;
      img.alt = r.label;
    }, 80);

    setTimeout(() => {
      clearInterval(shuffle);

      let fs = finalSymbols[i];
      img.src = fs.file;
      img.alt = fs.label;

      reel.classList.remove("spinning");
      stops++;

      if (stops === 4) {
        finishSpin(finalSymbols);
      }

    }, durations[i]);
  });
}

// ========================
// Fin du spin
// ========================

function finishSpin(symbols) {

  isSpinning = false;

  let ids = symbols.map(s => s.id);
  let allSame = ids.every(x => x === ids[0]);
  let winSymbol = symbols[0];

  if (allSame) {
    let type = "big";
    if (winSymbol.id === "loup") type = "giga";
    if (winSymbol.id === "moto") type = "mega";

    showWinBanner(type, winSymbol);

    // â†’ Ajouter dans lâ€™historique
    if (currentPlayer) {
      addWinner(currentPlayer.pseudo, winSymbol.label);
    }
  }

  // Si le joueur a fini ses tours â†’ passer au suivant
  if (currentPlayer) {
    if (currentPlayer.tours <= 0) {
      queue.shift();
      currentPlayer = null;
      renderQueue();
      startNextPlayer();
    }
  }
}

// ========================
// BanniÃ¨re WIN
// ========================

function showWinBanner(type, symbol) {
  winBanner.style.display = "flex";

  let label = "BIG WIN";
  if (type === "mega") label = "MEGA WIN";
  if (type === "giga") label = "GIGA WIN";

  winTypeLabel.textContent = label;
  winSymbolLabel.textContent = `4Ã— ${symbol.label}`;

  setTimeout(() => {
    winBanner.style.display = "none";
  }, 3500);
}

</script>
</body>
</html>
