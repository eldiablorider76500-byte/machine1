<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Slot 3B TikTok</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d3350 0, #050811 55%, #02030a 100%);
      color:#fff;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .app {
      width:95vw;
      max-width:1400px;
      height:92vh;
      max-height:720px;
      border-radius:40px;
      padding:20px 26px 26px;
      background:linear-gradient(180deg,#2c0f33 0%,#120615 50%,#20183b 100%);
      box-shadow:0 0 40px rgba(0,0,0,0.8),0 0 80px rgba(147,51,234,0.6);
      display:flex;
      flex-direction:column;
      position:relative;
      overflow:hidden;
    }

    .app-main {
      flex:1;
      display:flex;
      gap:18px;
      margin-top:10px;
    }

    .machine-column {
      flex:1.6;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .side-column {
      flex:0.9;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .machine-header {
      text-align:center;
      margin-bottom:4px;
    }

    .machine-title {
      font-size:32px;
      letter-spacing:3px;
      text-transform:uppercase;
      font-weight:800;
      color:#ffd54f;
      text-shadow:0 0 12px rgba(255,215,0,0.9),0 0 24px rgba(255,64,129,0.7);
    }

    .machine-subtitle {
      margin-top:4px;
      font-size:13px;
      color:#e1e1ff;
      opacity:0.85;
    }

    .top-status {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:4px 0 6px;
      font-size:13px;
      color:#e5e5ff;
    }

    .player-info span {
      font-weight:600;
      color:#ffeb3b;
    }

    .spin-counter {
      font-size:12px;
      color:#b0a5ff;
    }

    .reels-container {
      flex:1;
      border-radius:26px;
      padding:18px 14px;
      background:radial-gradient(circle at top,#3147a0,#0b1023 55%,#040612 100%);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }

    .reels-frame {
      width:100%;
      max-width:820px;
      height:100%;
      max-height:320px;
      border-radius:22px;
      padding:16px;
      background:linear-gradient(180deg,#ff00b8,#ff9100);
      box-shadow:0 0 28px rgba(255,64,129,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .reels-inner {
      flex:1;
      height:100%;
      background:radial-gradient(circle at top,#121b33,#050814 70%);
      border-radius:18px;
      border:4px solid rgba(255,255,255,0.05);
      display:flex;
      justify-content:space-evenly;
      align-items:center;
      padding:10px 14px;
      gap:10px;
    }

    .reel {
      flex:1;
      max-width:150px;
      height:100%;
      border-radius:16px;
      background:linear-gradient(180deg,#171f33,#050713);
      box-shadow:inset 0 0 15px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }

    .reel img {
      width:80%;
      max-height:90%;
      object-fit:contain;
      filter:drop-shadow(0 0 12px rgba(0,0,0,0.9));
      transition:transform 0.08s linear;
    }

    .reel.spinning img {
      animation:wiggle 0.1s linear infinite;
      opacity:0.9;
    }

    @keyframes wiggle {
      0%{transform:translateY(-4px);}
      50%{transform:translateY(4px);}
      100%{transform:translateY(-4px);}
    }

    .win-banner {
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      padding:6px 16px;
      border-radius:999px;
      background:rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.2);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:1px;
      color:#fff;
      display:none;
      align-items:center;
      gap:8px;
      pointer-events:none;
      z-index:5;
    }

    .win-banner span { font-weight:700; }
    .win-banner.big span  { color:#ffeb3b; }
    .win-banner.mega span { color:#00e5ff; }
    .win-banner.giga span { color:#ff1744; }

    .machine-footer {
      display:flex;
      gap:14px;
      align-items:center;
      margin-top:4px;
    }

    .control-panel {
      flex:2;
      background:rgba(0,0,0,0.4);
      border-radius:18px;
      padding:10px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      align-items:flex-start;
      font-size:13px;
    }

    .control-panel label {
      font-size:12px;
      color:#ddd;
    }

    .control-panel input {
      background:rgba(7,10,26,0.9);
      border:1px solid rgba(255,255,255,0.15);
      color:#fff;
      border-radius:999px;
      padding:5px 10px;
      font-size:13px;
      outline:none;
      min-width:110px;
    }

    .control-panel input:focus {
      border-color:#ff80ff;
      box-shadow:0 0 0 1px rgba(255,128,255,0.4);
    }

    .helper-text {
      font-size:10px;
      color:#b9b9ff;
      margin-top:4px;
      max-width:360px;
    }

    .buttons-panel {
      flex:0.9;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .btn {
      border-radius:999px;
      border:none;
      padding:9px 18px;
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      cursor:pointer;
      transition:transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .btn:disabled {
      opacity:0.40;
      cursor:not-allowed;
      box-shadow:none;
    }

    .btn-primary {
      background:radial-gradient(circle at top,#00e676,#00b0ff);
      color:#011017;
      box-shadow:0 0 14px rgba(0,230,118,0.6);
    }

    .btn-secondary {
      background:radial-gradient(circle at top,#ffea00,#ff6f00);
      color:#120300;
      box-shadow:0 0 14px rgba(255,193,7,0.6);
    }

    .btn:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 0 18px rgba(255,255,255,0.35);
    }

    .btn:active:not(:disabled) {
      transform:translateY(0px) scale(0.98);
      box-shadow:0 0 8px rgba(255,255,255,0.2);
    }

    /* Side column */

    .side-card {
      background:rgba(0,0,0,0.5);
      border-radius:18px;
      padding:10px 14px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .side-title {
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#ffeb3b;
    }

    .side-sub {
      font-size:11px;
      color:#b9b9ff;
    }

    .side-content {
      font-size:12px;
      color:#f5f5ff;
      max-height:150px;
      overflow-y:auto;
    }

    .queue-item {
      margin-bottom:2px;
    }

    .winner-item {
      margin-bottom:2px;
    }

    .status-dot {
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:6px;
      background:#f44336;
    }

    .status-dot.online {
      background:#00e676;
    }

    @media (max-width:1100px){
      .app-main {
        flex-direction:column;
      }
      .side-column {
        flex-direction:row;
      }
    }

    @media (max-width:900px){
      .app {
        padding:16px;
      }
      .machine-title { font-size:26px; }
      .machine-footer {
        flex-direction:column;
        align-items:stretch;
      }
      .buttons-panel { justify-content:center; }
      .side-column { flex-direction:column; }
    }

    /* Effets plein écran */
    .fx {
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:30;
    }

    .hidden { display:none; }

    .fx-fireworks {
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,0,0.5), transparent 60%),
        radial-gradient(circle at 80% 40%, rgba(255,0,0,0.5), transparent 60%),
        radial-gradient(circle at 40% 80%, rgba(0,200,255,0.5), transparent 60%),
        rgba(0,0,0,0.7);
      animation:fireworks 1.2s ease-out infinite;
    }

    @keyframes fireworks {
      0%{opacity:0; transform:scale(1);}
      30%{opacity:1; transform:scale(1.02);}
      100%{opacity:0; transform:scale(1.05);}
    }

    .fx-confetti {
      background-image:
        repeating-linear-gradient(to bottom, rgba(255,0,0,0.5) 0 10px, transparent 10px 20px),
        repeating-linear-gradient(to right, rgba(0,255,0,0.5) 0 10px, transparent 10px 20px);
      animation:confetti 1.2s linear infinite;
    }

    @keyframes confetti {
      0%{background-position:0 0,0 0; opacity:0;}
      20%{opacity:1;}
      100%{background-position:0 200px,200px 0; opacity:0;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="machine-header">
      <div class="machine-title">SLOT 3B TIKTOK</div>
      <div class="machine-subtitle">
        4 mêmes cadeaux sur la ligne = gain • Loup = <strong>GIGA WIN</strong> • Moto = <strong>MEGA WIN</strong>
      </div>
    </div>

    <div class="top-status">
      <div class="player-info">
        Joueur : <span id="playerNameDisplay">-</span> • Tours restants : <span id="spinsLeftDisplay">0</span>
      </div>
      <div class="spin-counter">
        Tours joués : <span id="totalSpinsDisplay">0</span> • Depuis gros gain : <span id="sinceBigDisplay">0</span>
      </div>
    </div>

    <div class="app-main">
      <!-- COLONNE MACHINE -->
      <div class="machine-column">
        <div class="reels-container">
          <div id="winBanner" class="win-banner">
            <span id="winTypeLabel"></span> — <span id="winSymbolLabel"></span>
          </div>

          <div class="reels-frame">
            <div class="reels-inner">
              <div class="reel" data-index="0"><img src="" alt="reel 1"></div>
              <div class="reel" data-index="1"><img src="" alt="reel 2"></div>
              <div class="reel" data-index="2"><img src="" alt="reel 3"></div>
              <div class="reel" data-index="3"><img src="" alt="reel 4"></div>
            </div>
          </div>
        </div>

        <div class="machine-footer">
          <div class="control-panel">
            <div>
              <label for="playerName">Pseudo TikTok (manuel) :</label><br>
              <input id="playerName" type="text" placeholder="Pseudo..." />
            </div>
            <div>
              <label for="giftCoins">Valeur du cadeau (pièces) :</label><br>
              <input id="giftCoins" type="number" min="1" placeholder="ex: 99" />
            </div>
            <div class="helper-text">
              Minimum <strong>49 pièces</strong> pour jouer.<br>
              49–98 = 1 tour • 99–298 = 3 tours • 299–2998 = 7 tours • 2999+ = 70 tours.<br>
              Les cadeaux TikTok reçus par @el_diablorider ajoutent automatiquement les joueurs dans la file.
            </div>
          </div>

          <div class="buttons-panel">
            <button id="addManualBtn" class="btn btn-secondary">Ajouter (manuel)</button>
            <button id="spinBtn" class="btn btn-primary" disabled>SPIN</button>
          </div>
        </div>
      </div>

      <!-- COLONNE DROITE -->
      <div class="side-column">
        <div class="side-card">
          <div class="side-title">File d'attente</div>
          <div class="side-sub">Nombre de joueurs : <span id="queueCount">0</span></div>
          <div id="queueList" class="side-content">
            Personne dans la file.
          </div>
        </div>

        <div class="side-card">
          <div class="side-title">Historique des gagnants (session)</div>
          <div class="side-sub">Total gagnants : <span id="winnersCount">0</span></div>
          <div id="winnersList" class="side-content">
            Aucun gagnant pour l'instant.
          </div>
        </div>

        <div class="side-card">
          <div class="side-title">Statut TikTok</div>
          <div class="side-content">
            <span id="tiktokDot" class="status-dot"></span>
            <span id="tiktokStatusText">Déconnecté du serveur</span>
          </div>
          <div id="tiktokHelp" class="side-sub">
            Lance ton serveur Node puis un vrai live TikTok avec @el_diablorider.<br>
            Les cadeaux valides seront ajoutés automatiquement dans la file.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Effets plein écran -->
  <div id="fx-fireworks" class="fx fx-fireworks hidden"></div>
  <div id="fx-confetti" class="fx fx-confetti hidden"></div>

  <script>
    /**************************************
     * CONFIG IMAGES & SYMBOLS
     **************************************/
    const IMAGE_BASE_PATH = "Cadeaux/"; // Dossier Cadeaux à côté de ce fichier

    const SYMBOLS = [
      { id:"cygne",        file:"IMG-20251120-WA0017.jpg", label:"Cygne royal",        isBig:false },
      { id:"loup",         file:"IMG-20251120-WA0018.jpg", label:"Loup",               isBig:true,  bigType:"giga" },
      { id:"rosejamais",   file:"IMG-20251120-WA0019.jpg", label:"Rose à jamais",      isBig:false },
      { id:"casquette",    file:"IMG-20251120-WA0020.jpg", label:"Casquette",          isBig:false },
      { id:"manette",      file:"IMG-20251120-WA0021.jpg", label:"Manette de jeu",     isBig:false },
      { id:"confetti",     file:"IMG-20251120-WA0022.jpg", label:"Confetti",           isBig:false },
      { id:"amourlangage", file:"IMG-20251120-WA0023.jpg", label:"Amour en langage",   isBig:false },
      { id:"donuts",       file:"IMG-20251120-WA0024.jpg", label:"Donut",              isBig:false },
      { id:"glace",        file:"IMG-20251120-WA0025.jpg", label:"Cornet glacé",       isBig:false },
      { id:"parfum",       file:"IMG-20251120-WA0026.jpg", label:"Parfum",             isBig:false },
      { id:"corgi",        file:"IMG-20251120-WA0027.jpg", label:"Corgi",              isBig:false },
      { id:"gants",        file:"IMG-20251120-WA0028.jpg", label:"Gants de boxe",      isBig:false },
      { id:"rosa",         file:"IMG-20251120-WA0029.jpg", label:"Rosa",               isBig:false },
      { id:"gg",           file:"IMG-20251120-WA0030.jpg", label:"GG",                 isBig:false },
      { id:"positivite",   file:"IMG-20251120-WA0031.jpg", label:"De la positivité",   isBig:false },
      { id:"tofu",         file:"IMG-20251120-WA0032.jpg", label:"Tofu",               isBig:false },
      { id:"coeurdoigts",  file:"IMG-20251120-WA0033.jpg", label:"Cœur avec les doigts", isBig:false },
      { id:"coeurnuage",   file:"IMG-20251120-WA0034.jpg", label:"Cœur nuage",         isBig:false },
      { id:"moto",         file:"IMG-20251120-WA0035.jpg", label:"Moto",               isBig:true,  bigType:"mega" },
      { id:"pistolet",     file:"IMG-20251120-WA0042.jpg", label:"Pistolet à argent",  isBig:false }
    ];

    const NON_BIG_SYMBOLS = SYMBOLS.filter(s => !s.isBig);

    // Petits lots 15–20
    const SMALL_REWARD_IDS = [
      "donuts","rosa","manette","confetti",
      "parfum","tofu","glace","casquette"
    ];

    // Lots 70 tours
    const MEDIUM_REWARD_IDS = [
      "rosejamais","pistolet","corgi","casquette",
      "positivite","confetti","amourlangage","rosa","parfum"
    ];

    // Cycle complet 260+
    const BIG_260_SEQUENCE = [
      "cygne","pistolet","moto","loup",
      "pistolet","cygne","moto","pistolet","loup",
      "cygne","moto","cygne","pistolet","moto","loup"
    ];
    let big260Index = 0;

    /**************************************
     * ÉTAT GLOBAL
     **************************************/
    let totalSpins = 0;
    let spinsSinceBig = 0;

    let nextSmallRewardAt = getRandomInt(15, 20);
    let moto200Given = false;
    let lastRewardSource = null; // "200" / "260" / "70" / "small" / null

    // File d'attente & joueur courant
    let queue = []; // { name, spinsLeft }
    let currentPlayer = null;
    let winnersHistory = [];
    let winnersCount = 0;

    // Spin
    let isSpinning = false;

    /**************************************
     * SÉLECTEURS DOM
     **************************************/
    const reels = Array.from(document.querySelectorAll(".reel"));
    const winBanner = document.getElementById("winBanner");
    const winTypeLabel = document.getElementById("winTypeLabel");
    const winSymbolLabel = document.getElementById("winSymbolLabel");

    const playerNameDisplay = document.getElementById("playerNameDisplay");
    const spinsLeftDisplay = document.getElementById("spinsLeftDisplay");
    const totalSpinsDisplay = document.getElementById("totalSpinsDisplay");
    const sinceBigDisplay = document.getElementById("sinceBigDisplay");

    const addManualBtn = document.getElementById("addManualBtn");
    const spinBtn = document.getElementById("spinBtn");

    const queueListEl = document.getElementById("queueList");
    const queueCountEl = document.getElementById("queueCount");
    const winnersListEl = document.getElementById("winnersList");
    const winnersCountEl = document.getElementById("winnersCount");

    const tiktokDot = document.getElementById("tiktokDot");
    const tiktokStatusText = document.getElementById("tiktokStatusText");

    const fxFireworks = document.getElementById("fx-fireworks");
    const fxConfetti = document.getElementById("fx-confetti");

    /**************************************
     * FONCTIONS UTILITAIRES
     **************************************/
    function getSymbolById(id){
      return SYMBOLS.find(s => s.id === id);
    }
    function randomSymbol(pool = SYMBOLS){
      return pool[Math.floor(Math.random() * pool.length)];
    }
    function randomNonBigSymbol(){
      return randomSymbol(NON_BIG_SYMBOLS);
    }
    function getRandomInt(min, max){
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function calcSpinsFromCoins(coins){
      if (coins >= 2999) return 70;
      if (coins >= 299)  return 7;
      if (coins >= 99)   return 3;
      if (coins >= 49)   return 1;
      return 0;
    }

    /**************************************
     * AFFICHAGES
     **************************************/
    function updateTopStatus(){
      if (currentPlayer){
        playerNameDisplay.textContent = currentPlayer.name;
        spinsLeftDisplay.textContent = currentPlayer.spinsLeft;
      } else {
        playerNameDisplay.textContent = "-";
        spinsLeftDisplay.textContent = "0";
      }
      totalSpinsDisplay.textContent = totalSpins.toString();
      sinceBigDisplay.textContent = spinsSinceBig.toString();
    }

    function updateQueueDisplay(){
      queueCountEl.textContent = queue.length.toString();
      if (queue.length === 0){
        queueListEl.textContent = "Personne dans la file.";
        return;
      }
      queueListEl.innerHTML = "";
      queue.forEach((p, index) => {
        const div = document.createElement("div");
        div.className = "queue-item";
        div.textContent = `${index+1}. ${p.name} — ${p.spinsLeft} tour(s)`;
        queueListEl.appendChild(div);
      });
    }

    function updateWinnersDisplay(){
      winnersCountEl.textContent = winnersCount.toString();
      if (winnersHistory.length === 0){
        winnersListEl.textContent = "Aucun gagnant pour l'instant.";
        return;
      }
      winnersListEl.innerHTML = "";
      winnersHistory.slice(-50).forEach(w => {
        const div = document.createElement("div");
        div.className = "winner-item";
        div.textContent = `${w.name} — ${w.symbol}`;
        winnersListEl.appendChild(div);
      });
    }

    function showWinBanner(type, symbol){
      let cls = "";
      let label = "";
      if (type === "giga") { cls="giga"; label="GIGA WIN"; }
      else if (type === "mega") { cls="mega"; label="MEGA WIN"; }
      else if (type === "big") { cls="big"; label="BIG WIN"; }
      else {
        winBanner.style.display = "none";
        return;
      }

      winBanner.classList.remove("big","mega","giga");
      winBanner.classList.add(cls);
      winTypeLabel.textContent = `${label} pour ${currentPlayer ? currentPlayer.name : "-"}`;
      winSymbolLabel.textContent = `4× ${symbol.label}`;
      winBanner.style.display = "flex";

      fxFireworks.classList.add("hidden");
      fxConfetti.classList.add("hidden");

      if (type === "giga") {
        fxFireworks.classList.remove("hidden");
      } else if (type === "mega") {
        fxConfetti.classList.remove("hidden");
      }

      setTimeout(() => { hideWinBanner(); }, 4000);
    }

    function hideWinBanner(){
      winBanner.style.display = "none";
      fxFireworks.classList.add("hidden");
      fxConfetti.classList.add("hidden");
    }

    function initReels(){
      reels.forEach(reel => {
        const img = reel.querySelector("img");
        const sym = randomSymbol();
        img.src   = IMAGE_BASE_PATH + sym.file;
        img.alt   = sym.label;
        reel.dataset.symbolId = sym.id;
      });
    }

    /**************************************
     * FILE D'ATTENTE
     **************************************/
    function ensureCurrentPlayer(){
      if (!currentPlayer && queue.length > 0){
        currentPlayer = queue.shift();
        spinBtn.disabled = false;
      }
      if (!currentPlayer){
        spinBtn.disabled = true;
      }
      updateTopStatus();
      updateQueueDisplay();
    }

    function addPlayerFromGift(username, coins){
      const spins = calcSpinsFromCoins(coins);
      if (spins === 0) return;

      // Si déjà joueur courant
      if (currentPlayer && currentPlayer.name === username){
        currentPlayer.spinsLeft += spins;
        updateTopStatus();
        return;
      }

      // Si déjà dans la file
      const existing = queue.find(p => p.name === username);
      if (existing){
        existing.spinsLeft += spins;
      } else {
        queue.push({ name: username, spinsLeft: spins });
      }

      ensureCurrentPlayer();
    }

    /**************************************
     * LOGIQUE DE RÉSULTAT (TON ANCIEN SCRIPT)
     **************************************/
    function computeFinalSymbols(){
      totalSpins++;
      spinsSinceBig++;
      const spinIndex = totalSpins;

      let forcedSymbolId = null;
      lastRewardSource = null;

      // 1) première fois 200 → moto
      if (!moto200Given && spinIndex === 200) {
        forcedSymbolId   = "moto";
        moto200Given     = true;
        lastRewardSource = "200";
      }
      // 2) >200 et multiple de 260 → cycle spécial
      else if (spinIndex > 200 && spinIndex % 260 === 0) {
        forcedSymbolId   = BIG_260_SEQUENCE[big260Index];
        big260Index      = (big260Index + 1) % BIG_260_SEQUENCE.length;
        lastRewardSource = "260";
      }
      // 3) multiple de 70
      else if (spinIndex % 70 === 0) {
        forcedSymbolId   = MEDIUM_REWARD_IDS[Math.floor(Math.random() * MEDIUM_REWARD_IDS.length)];
        lastRewardSource = "70";
      }
      // 4) petit lot 15–20
      else if (spinIndex === nextSmallRewardAt) {
        forcedSymbolId   = SMALL_REWARD_IDS[Math.floor(Math.random() * SMALL_REWARD_IDS.length)];
        nextSmallRewardAt = spinIndex + getRandomInt(15, 20);
        lastRewardSource = "small";
      }

      const finalSymbols = [];

      if (forcedSymbolId) {
        const sym = getSymbolById(forcedSymbolId);
        for (let i = 0; i < 4; i++) finalSymbols.push(sym);
      } else {
        for (let i = 0; i < 4; i++) finalSymbols.push(randomNonBigSymbol());
      }

      return finalSymbols;
    }

    /**************************************
     * SPIN
     **************************************/
    function applyPrizeRules(finalSymbols, finalIds){
      const allSame = finalIds.every(id => id === finalIds[0]);
      if (!allSame) {
        hideWinBanner();
        return;
      }

      const winningSymbol = finalSymbols[0];

      // Reset compteur “depuis gros gain” si gros gain
      if (winningSymbol.isBig) {
        spinsSinceBig = 0;
      }

      if (winningSymbol.isBig) {
        if (winningSymbol.id === "loup") {
          showWinBanner("giga", winningSymbol);
        } else if (winningSymbol.id === "moto") {
          showWinBanner("mega", winningSymbol);
        } else {
          showWinBanner("big", winningSymbol);
        }
      } else {
        showWinBanner("big", winningSymbol);
      }

      // Effet spécial pour les tours 260
      if (lastRewardSource === "260") {
        fxFireworks.classList.remove("hidden");
        fxConfetti.classList.remove("hidden");
      }

      // Ajout au tableau des gagnants
      if (currentPlayer){
        winnersHistory.push({ name: currentPlayer.name, symbol: winningSymbol.label });
        winnersCount++;
        updateWinnersDisplay();
      }
    }

    function startSpin(){
      if (!currentPlayer || currentPlayer.spinsLeft <= 0) {
        ensureCurrentPlayer();
        if (!currentPlayer) return;
      }
      if (isSpinning) return;

      currentPlayer.spinsLeft--;
      updateTopStatus();

      isSpinning = true;
      hideWinBanner();

      const finalSymbols = computeFinalSymbols();
      const finalIds = new Array(4);

      const reelDurations = [1600, 2000, 2400, 2800];
      let reelsStopped = 0;

      reels.forEach((reel, index) => {
        reel.classList.add("spinning");
        const img = reel.querySelector("img");

        const shuffleInterval = setInterval(() => {
          const sym = randomSymbol();
          img.src = IMAGE_BASE_PATH + sym.file;
          img.alt = sym.label;
        }, 80);

        setTimeout(() => {
          clearInterval(shuffleInterval);

          const finalSym = finalSymbols[index];
          finalIds[index] = finalSym.id;

          img.src = IMAGE_BASE_PATH + finalSym.file;
          img.alt = finalSym.label;
          reel.dataset.symbolId = finalSym.id;
          reel.classList.remove("spinning");

          reelsStopped++;
          if (reelsStopped === reels.length) {
            applyPrizeRules(finalSymbols, finalIds);
            isSpinning = false;

            // Si plus de tours pour ce joueur → suivant
            if (!currentPlayer || currentPlayer.spinsLeft <= 0) {
              currentPlayer = null;
              ensureCurrentPlayer();
            }

            updateTopStatus();
          }
        }, reelDurations[index]);
      });
    }

    /**************************************
     * ÉVÉNEMENTS BOUTONS
     **************************************/
    addManualBtn.addEventListener("click", () => {
      const name = document.getElementById("playerName").value.trim();
      const coins = parseInt(document.getElementById("giftCoins").value, 10);

      if (!name){
        alert("Merci d'entrer le pseudo TikTok.");
        return;
      }
      if (isNaN(coins) || coins <= 0){
        alert("Merci d'entrer le nombre de pièces du cadeau.");
        return;
      }

      addPlayerFromGift(name, coins);
      document.getElementById("playerName").value = "";
      document.getElementById("giftCoins").value = "";
    });

    spinBtn.addEventListener("click", () => {
      startSpin();
    });

    /**************************************
     * WEBSOCKET AVEC TON SERVEUR NODE
     **************************************/
    function setupWebSocket(){
      try {
        const ws = new WebSocket("ws://localhost:8080");

        ws.onopen = () => {
          tiktokDot.classList.add("online");
          tiktokStatusText.textContent = "Connecté au serveur (en attente de cadeaux)";
        };

        ws.onclose = () => {
          tiktokDot.classList.remove("online");
          tiktokStatusText.textContent = "Déconnecté du serveur";
        };

        ws.onerror = () => {
          tiktokDot.classList.remove("online");
          tiktokStatusText.textContent = "Erreur de connexion au serveur";
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "gift"){
              addPlayerFromGift(data.username, data.coins);
            }
          } catch(e){
            console.error("Message invalide :", e);
          }
        };
      } catch (e){
        console.error("Impossible de créer le WebSocket", e);
      }
    }

    /**************************************
     * INIT
     **************************************/
    initReels();
    updateTopStatus();
    updateQueueDisplay();
    updateWinnersDisplay();
    setupWebSocket();
  </script>
</body>
</html>
