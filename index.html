<script>
  // ===== CONFIG =====
  const MIN_COINS = 49;

  // Mapping de TOUS tes cadeaux avec les BONS fichiers
  // (les images sont dans le dossier Cadeaux/)
  const symbols = [
    { id: "cygne",           name: "Cygne",              label: "Cygne",               img: "Cadeaux/IMG-20251120-WA0017.jpg" },
    { id: "loup",            name: "Loup",               label: "Loup",                img: "Cadeaux/IMG-20251120-WA0018.jpg" },
    { id: "rose_ajamais",    name: "Rose √† jamais",      label: "Rose √† jamais",       img: "Cadeaux/IMG-20251120-WA0019.jpg" },
    { id: "casquette",       name: "Casquette",          label: "Casquette",           img: "Cadeaux/IMG-20251120-WA0020.jpg" },
    { id: "manette",         name: "Manette de jeu",     label: "Manette de jeu",      img: "Cadeaux/IMG-20251120-WA0021.jpg" },
    { id: "confettis",       name: "Confettis",          label: "Confettis",           img: "Cadeaux/IMG-20251120-WA0022.jpg" },
    { id: "amour_langage",   name: "Amour en langage",   label: "Amour en langage",    img: "Cadeaux/IMG-20251120-WA0023.jpg" },
    { id: "donut",           name: "Donut",              label: "Donut",               img: "Cadeaux/IMG-20251120-WA0024.jpg" },
    { id: "cornet_glace",    name: "Cornet de glace",    label: "Cornet glac√©",        img: "Cadeaux/IMG-20251120-WA0025.jpg" },
    { id: "parfum",          name: "Parfum",             label: "Parfum",              img: "Cadeaux/IMG-20251120-WA0026.jpg" },
    { id: "corgi",           name: "Corgi",              label: "Corgi",               img: "Cadeaux/IMG-20251120-WA0027.jpg" },
    { id: "gants_boxe",      name: "Gants dor√©s",        label: "Gants de boxe dor√©s", img: "Cadeaux/IMG-20251120-WA0028.jpg" },
    { id: "rosa",            name: "Rosa",               label: "Rosa",                img: "Cadeaux/IMG-20251120-WA0029.jpg" },
    { id: "gg",              name: "GG",                 label: "GG",                  img: "Cadeaux/IMG-20251120-WA0030.jpg" },
    { id: "positivite",      name: "Positivit√©",         label: "De la positivit√©",    img: "Cadeaux/IMG-20251120-WA0031.jpg" },
    { id: "tofu",            name: "Tofu",               label: "Tofu",                img: "Cadeaux/IMG-20251120-WA0032.jpg" },
    { id: "coeur_doigts",    name: "C≈ìur doigts",        label: "C≈ìur avec les doigts",img: "Cadeaux/IMG-20251120-WA0033.jpg" },
    { id: "coeur_nuage",     name: "C≈ìur nuage",         label: "C≈ìur nuage",          img: "Cadeaux/IMG-20251120-WA0034.jpg" },
    { id: "moto",            name: "Moto",               label: "Moto",                img: "Cadeaux/IMG-20251120-WA0035.jpg" },
    { id: "pistolet_argent", name: "Pistolet argent",    label: "Pistolet √† argent",   img: "Cadeaux/IMG-20251120-WA0042.jpg" }
  ];

  // R√®gles de gros gains
  const GIGA_KEY = "loup"; // 4 loups
  const MEGA_KEY = "moto"; // 4 motos
  // Tout autre 4√ó identiques = BIG WIN

  const reels = Array.from(document.querySelectorAll(".reel"));
  const statusEl = document.getElementById("status");
  const spinButton = document.getElementById("spinButton");
  const reelsFrame = document.getElementById("reelsFrame");
  const playerNameEl = document.getElementById("playerName");
  const minCoinsTextEl = document.getElementById("minCoinsText");

  minCoinsTextEl.textContent = MIN_COINS;

  let isSpinning = false;

  function randomSymbol() {
    return symbols[Math.floor(Math.random() * symbols.length)];
  }

  function renderSymbol(el, symbolData) {
    el.innerHTML = "";

    const img = document.createElement("img");
    img.src = symbolData.img;
    img.alt = symbolData.name;
    img.className = "gift-img";

    // si l'image ne charge pas, on met juste le texte
    img.onerror = () => {
      el.innerHTML = `<div class="gift-caption">IMAGE MANQUANTE : ${symbolData.name}</div>`;
    };

    const caption = document.createElement("div");
    caption.className = "gift-caption";
    caption.textContent = symbolData.name.toUpperCase();

    el.appendChild(img);
    el.appendChild(caption);
  }

  function onSpinEnd(results, user) {
    const allSame = results.every((id) => id === results[0]);
    const symbolData = symbols.find((s) => s.id === results[0]) || null;

    reelsFrame.classList.remove("win");
    statusEl.classList.remove("win", "lose", "error");

    if (!allSame) {
      statusEl.textContent = "Pas 4 m√™mes cadeaux‚Ä¶ prochain cadeau TikTok pour relancer.";
      statusEl.classList.add("lose");
    } else {
      let tier;
      if (results[0] === GIGA_KEY) {
        tier = "GIGAWIN";
      } else if (results[0] === MEGA_KEY) {
        tier = "MEGAWIN";
      } else {
        tier = "BIG WIN";
      }
      const label = symbolData ? symbolData.label : results[0];
      statusEl.textContent = `${tier} pour ${user} ! 4√ó ${label} üéÅ`;
      statusEl.classList.add("win");
      reelsFrame.classList.add("win");
    }

    isSpinning = false;
    spinButton.classList.remove("disabled");
  }

  function spinForEvent({ user, coins }) {
    if (isSpinning) return;

    if (!user) user = "Viewer";
    playerNameEl.textContent = `Joueur : ${user}`;

    if (typeof coins !== "number") coins = 0;

    // ‚úÖ Minimum 49 pi√®ces
    if (coins < MIN_COINS) {
      statusEl.textContent = `${user} n'a envoy√© que ${coins} pi√®ces (min ${MIN_COINS}). Pas de spin.`;
      statusEl.classList.remove("win", "lose");
      statusEl.classList.add("error");
      return;
    }

    isSpinning = true;
    spinButton.classList.add("disabled");
    reelsFrame.classList.remove("win");
    statusEl.classList.remove("win", "lose", "error");
    statusEl.textContent = `Spin en cours pour ${user}‚Ä¶`;

    const finalResults = [];
    let reelsFinished = 0;

    reels.forEach((reel, index) => {
      const symbolEl = reel.querySelector("[data-symbol]");
      let elapsed = 0;
      const spinDuration = 3000 + index * 300; // 3s, 3.3s, 3.6s, 3.9s

      reel.classList.add("spinning");

      const interval = setInterval(() => {
        const s = randomSymbol();
        renderSymbol(symbolEl, s);
        elapsed += 100;
        if (elapsed >= spinDuration) {
          clearInterval(interval);
          const finalSymbol = randomSymbol();
          renderSymbol(symbolEl, finalSymbol);
          finalResults[index] = finalSymbol.id;
          reel.classList.remove("spinning");
          reelsFinished++;
          if (reelsFinished === reels.length) {
            onSpinEnd(finalResults, user);
          }
        }
      }, 100);
    });
  }

  // Bouton test (offline)
  spinButton.addEventListener("click", () => {
    spinForEvent({
      user: "TestUser",
      coins: 100 // >= 49 pour que √ßa tourne
    });
  });

  // Initialisation : afficher 1 symbole al√©atoire par rouleau
  reels.forEach((reel) => {
    const symbolEl = reel.querySelector("[data-symbol]");
    const s = randomSymbol();
    renderSymbol(symbolEl, s);
  });

  // API pour Tikfinity :
  // window.tiktokSpin({ user: 'Pseudo', coins: 80 })
  window.tiktokSpin = function(event) {
    spinForEvent(event || {});
  };
</script>
